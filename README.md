# Supabase Inactive Fix

![GitHub stars](https://img.shields.io/github/stars/gubnota/supabase-inactive-fix?style=social)
![GitHub forks](https://img.shields.io/github/forks/gubnota/supabase-inactive-fix?style=social)
![GitHub repo size](https://img.shields.io/github/repo-size/gubnota/supabase-inactive-fix)
![GitHub language count](https://img.shields.io/github/languages/count/gubnota/supabase-inactive-fix)
![GitHub top language](https://img.shields.io/github/languages/top/gubnota/supabase-inactive-fix)
![GitHub last commit](https://img.shields.io/github/last-commit/gubnota/supabase-inactive-fix?color=red)
![Hits](https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2Fgubnota%2Fsupabase-inactive-fix&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false)
[![](https://img.shields.io/static/v1?label=Sponsor&message=%E2%9D%A4&logo=GitHub&color=%23fe8e86)](https://img.shields.io/github/sponsors/gubnota)

This project helps prevent Supabase projects from pausing due to inactivity by periodically inserting, monitoring, and deleting entries in the specified tables of multiple Supabase databases. The project uses a configuration file (`config.json`) to define multiple databases and automate the keep-alive actions. Initially, this was a fork of [another project of the same name supabase-inactive-fix written by Travis Van Nimwegen](https://github.com/travisvn/supabase-inactive-fix). Unfortunately, the original version didn't work for me so I had to rewrite it.

## Features ⭐️

- Insert a random string into a specified table for each Supabase database.
- Monitor the number of entries in the table.
- Automatically delete entries if the table contains more than a specified number of records.
- Log successes and failures, and generate a detailed status report.

## Setup 🚀

1. Clone the repository:

   ```bash
   git clone https://github.com/gubnota/supabase-inactive-fix.git
   cd supabase-inactive-fix
   ```

2. Install the required dependencies using `poetry` or `uv`:

   ```bash
   poetry install
   ```

   or the old way:
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows use `venv\Scripts\activate`
   pip install -r requirements.txt
   ```

3. Create a `config.json` file in the project root. This file defines your Supabase databases.

   Example configuration:

   ```json
   [
     {
       "name": "Database1",
       "supabase_url": "https://your-supabase-url-1.supabase.co",
       "supabase_key_env": "SUPABASE_KEY_1", // Use environment variable for the key
       "table_name": "KeepAlive"
     },
     {
       "name": "Database2",
       "supabase_url": "https://your-supabase-url-2.supabase.co",
       "supabase_key": "your-direct-supabase-key", // Directly define the key
       "table_name": "keep-alive"
     }
   ]
   ```

   [See the section below for how to easily configure your database](#supabase-database-setup)

   ### Environment Variables Explained

   In the `config.json` file, you can define either:

   - **Direct API Key**: Use the `"supabase_key"` field to directly specify your Supabase API key.
   - **Environment Variable**: Use the `"supabase_key_env"` field to reference an environment variable where the key is stored. This is more secure, especially when running the script in different environments.

   #### Example:

   - `"supabase_key_env": "SUPABASE_KEY_1"`: This tells the script to look for an environment variable called `SUPABASE_KEY_1` that contains the actual API key.
   - `"supabase_key": "your-direct-supabase-key"`: This directly provides the API key within the `config.json` file, which is less secure but simpler for local setups.

4. Set up your environment variables _if you're using them_:

   Create a `.env` file and store variables there

   ```
   SUPABASE_KEY_1="your-supabase-key-1"
   SUPABASE_KEY_2="your-supabase-key-2"
   SUPABASE_KEY_3="your-supabase-key-3"
   SUPABASE_KEY_4="your-supabase-key-4"
   ```

5. Run the script:

   ```bash
   poetry run python main.py
   ```

   or the old way:

   ```bash
   source venv/bin/activate
   python main.py
   deactivate
   ```

## Supabase Database Setup 🔧

This project requires you to create a `keep-alive` table in your Postgres database on Supabase.
Or you can let the script to create it by itself (in that case look at `Functions` section).

### Sample SQL

Here's a SQL query for a `keep-alive` table

```sql
CREATE TABLE "keep-alive" (
  id BIGINT generated BY DEFAULT AS IDENTITY,
  name text NULL DEFAULT '':: text,
  random uuid NULL DEFAULT gen_random_uuid (),
  CONSTRAINT "keep-alive_pkey" PRIMARY key (id)
);

INSERT INTO
  "keep-alive"(name)
VALUES
  ('placeholder'),
  ('example');
```

## Cron Job Setup ⏱️

To automate this script, you can create a cron job that runs the script periodically. Below are instructions for setting this up on macOS, Linux, and Windows.

### macOS

In order to not have an error `Can't open input file: zsh` like this:
1. make sure cron has full disk access (either is poetry or uv)
```sh
0 * * * * "full/path/to/supabase-inactive-fix/run.sh" >/dev/null 2>&1
#* * * * * /bin/zsh -c "full/path/to/supabase-inactive-fix/run2.sh"
```
2. make sure cron_env.log is empty after running the script
3. remove  `>/dev/null 2>&1` and make sure if you run every minute it doesn't have any issues in /var/mail/{username}
4. make sure remote server table `keep-alive` has changed after running the script

### Linux

1. Open your crontab file for editing:

   ```bash
   crontab -e
   ```

2. Add a new cron job to run the script every Monday and Thursday at midnight:

   ```bash
   0 0 * * 1,4 cd /path/to/your/project && /path/to/your/project/venv/bin/python main.py >> /path/to/your/project/logfile.log 2>&1
   ```

This example cron job will:

- Navigate to the project directory.
- Run the Python script using the virtual environment.
- Append the output to a logfile.

For reference, here’s an example used in development:

```bash
0 0 * * 1,4 cd full/path/to/supabase-inactive-fix && full/path/to/supabase-inactive-fix/venv/bin/python main.py >> full/path/to/supabase-inactive-fix/logfile.log 2>&1
```

### Windows (Task Scheduler)

Windows does not have cron jobs, but you can achieve similar functionality using Task Scheduler.

1. Open **Task Scheduler** and select **Create Basic Task**.
2. Name the task and set the trigger to run weekly.
3. Set the days (e.g., Monday and Thursday) and time (e.g., midnight) when the script should run.
4. In the **Action** step, select **Start a Program**, and point it to your Python executable within your virtual environment. For example:

   ```vbnet
   C:\path\to\your\project\venv\Scripts\python.exe
   ```

5. In the **Arguments** field, specify the path to the script:

   ```vbnet
   C:\path\to\your\project\main.py
   ```

6. Save the task. The script will now run automatically according to the schedule you specified.

## Functions
Create functions in Postgres before you can create tables and truncate them:
```sql
CREATE OR REPLACE FUNCTION public.execute_sql(sql text)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  EXECUTE sql;
END;
$$;

CREATE OR REPLACE FUNCTION truncate_table(table_name TEXT)
RETURNS VOID AS $$
BEGIN
    EXECUTE 'TRUNCATE TABLE ' || quote_ident(table_name) || ' RESTART IDENTITY CASCADE';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```
Now you can run this command:
```py
    def truncate_table(self):
        try:
            # Send a raw SQL query to truncate the table
            self.client.rpc("truncate_table", {"table_name": self.table_name}).execute()
            print(f"Truncated '{self.table_name}'.")
            return True
        except Exception as e:
            print(f"Error truncating '{self.table_name}': {e}")
            return False

```

